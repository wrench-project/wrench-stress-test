FROM ubuntu:focal

MAINTAINER Rafael Ferreira da Silva <silvarf@ornl.gov>

ENV WRENCH_VERSION="2.2"

#################################################
# INSTALL WRENCH
#################################################

USER root
WORKDIR /tmp

RUN apt-get clean
RUN apt-get update

RUN apt-get install -y wget g++ gcc 
RUN apt-get install -y sudo
RUN apt-get install -y python3
RUN apt-get install -y doxygen
RUN apt-get install -y ghostscript
RUN apt-get install -y cmake
RUN apt-get install -y libboost-all-dev
RUN apt-get install -y glpk-utils
RUN apt-get install -y git
RUN apt-get install -y vim
RUN apt-get install -y time


# install pugixml
RUN wget https://github.com/zeux/pugixml/releases/download/v1.8.1/pugixml-1.8.1.tar.gz && tar -xf pugixml-1.8.1.tar.gz && cd pugixml-1.8 && cmake . && make && sudo make install && cd .. && rm -rf pugixml-1.8*

# install json for modern c++
RUN wget https://github.com/nlohmann/json/archive/v3.7.0.tar.gz && tar -xf v3.7.0.tar.gz && cd json-3.7.0 && cmake . && make && $SUDO make install && cd .. && rm -rf v3.7.0* json-3.7.0

# install googletest
RUN wget https://github.com/google/googletest/archive/release-1.8.0.tar.gz && tar xf release-1.8.0.tar.gz && cd googletest-release-1.8.0/googletest && cmake . && make && sudo make install && cd ../.. && rm -rf release-1.8.0.tar.gz googletest-release-1.8.0

# instal SIMGRID
ENV SIMGRID_VERSION="33"
RUN git clone https://framagit.org/simgrid/simgrid.git && cd simgrid && git checkout 5a4efdbedd401027e9650c825fc09449c5bd8d3c && mkdir build && cd build && cmake .. && make -j12 && sudo make install && cd ../.. && rm -rf simgrid

# install WRENCH
RUN git clone https://github.com/wrench-project/wrench.git && cd wrench && git checkout  WRENCH_COMMIT_ID && cmake . && make -j8 && sudo make install
#RUN git clone https://github.com/wrench-project/wrench.git && cd wrench && cmake . && make -j8 && sudo make install

# install wrench-stress-test
RUN git clone https://github.com/wrench-project/wrench-stress-test.git && cd wrench-stress-test && git checkout WRENCHSTRESSTEST_COMMIT_ID && cmake . && make -j8 && sudo cp wrench_stress_test /usr/local/bin/wrench-stress-test


#################################################
# WRENCH's user
#################################################


RUN useradd -ms /bin/bash wrench &&   echo 'wrench:wrench' | chpasswd
RUN echo '%sudo ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
RUN adduser wrench sudo

USER wrench
WORKDIR /home/wrench

# set user's environment variable
ENV CXX="g++-9" CC="gcc-9"
ENV LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/usr/local/lib

